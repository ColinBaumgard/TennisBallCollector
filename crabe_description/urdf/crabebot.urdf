<?xml version="1.0"?>

<robot name="crabe" xmlns:xacro="http://www.ros.org/wiki/xacro">

    <xacro:macro name="mat2">
        <mu1>0.15</mu1>
        <mu2>0.15</mu2>
        <kp>500000.0</kp>
        <kd>10.0</kd>
        <minDepth>0.001</minDepth>
        <maxVel>0.1</maxVel>
        <material>Gazebo/FlatBlack</material>
    </xacro:macro>

    <!-- box -->
    <xacro:property name="longueur" value="0.4" />
    <xacro:property name="largeur" value="0.5" />
    <xacro:property name="hauteur" value="0.2" />    
    <xacro:property name="mbase" value="10.0" />
    <xacro:property name="hauteur_chassis" value="1.5" />
    <xacro:property name="hauteur_benne" value="0.5" />
    <!-- roues -->
    <xacro:property name="r" value="0.2" />
    <xacro:property name="h" value="0.1" />
    <xacro:property name="eps" value="0.05" />
    <xacro:property name="mroue" value="1.0" />
    <!-- aileron -->
    <xacro:property name="l_aileron" value="0.2" />
    <xacro:property name="L_aileron" value="0.5" />
    <xacro:property name="h_aileron" value="0.05" />    
    <xacro:property name="m_aileron" value="0.5" />
    <!-- cibles -->
    <xacro:property name="r_cible" value="0.05" />
    <xacro:property name="h_cible" value="0.05" />
    <xacro:property name="m_cible" value="0.01" />
        
    <!-- Benne -->
    <xacro:property name="benne1X" value="0.1" />
    <xacro:property name="benne1Y" value="0.8" />
    <xacro:property name="benne1Z" value="0.2" />
    <xacro:property name="benne1_m" value="4" />

    <xacro:property name="benne2X" value="0.5" />
    <xacro:property name="benne2Y" value="0.1" />
    <xacro:property name="benne2Z" value="${benne1Z}" />
    <xacro:property name="benne2_m" value="3" />

    <!-- Free wheel -->
    <xacro:property name="free_r" value="0.05" />
    <xacro:property name="free_m" value="0.1" />




    <!-- Links-->
    <link name="base">
        <visual>
            <origin xyz="0 0 ${r/2+hauteur/2}" rpy="0 0 0"/>
            <geometry>
                <box size="${longueur} ${largeur} ${hauteur}"/>
            </geometry>
        </visual>
        <inertial>
            <origin xyz="0 0 ${r/2+hauteur/2}" rpy="0 0 0"/>
            <mass value="${mbase}"/>
            <inertia ixx="${mbase*(hauteur*hauteur+largeur*largeur)/12}" ixy="0.0" ixz="0.0" iyy="${mbase*(hauteur*hauteur+longueur*longueur)/12}" iyz="0.0" izz="${mbase*(largeur*largeur+longueur*longueur)/12}"/>
        </inertial>
        <collision>
            <origin xyz="0 0 ${r/2+hauteur/2}" rpy="0 0 0"/>
            <geometry>
                <box size="${longueur} ${largeur} ${hauteur}"/>
            </geometry>
        </collision>
    </link>
        <gazebo reference="base">
            <material>Gazebo/WhiteGlow</material>
        </gazebo>

    <link name="roue_gauche">
        <visual>
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <geometry>
                <cylinder radius="${r}" length="${h}"/>
            </geometry>
        </visual>
        <inertial>
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <mass value="${mroue}"/>
            <inertia ixx="${mroue*(3*r*r+h*h)/12}" ixy="0.0" ixz="0.0" iyy="${mroue*(3*r*r+h*h)/12}" iyz="0.0" izz="${mroue*r*r/2}"/>
        </inertial>
        <collision>
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <geometry>
                <cylinder radius="${r}" length="${h}"/>
            </geometry>
        </collision>
    </link>
        <gazebo reference="roue_gauche">
            <mu1>1.2</mu1>
            <mu2>1.2</mu2>
            <kp>500000.0</kp>
            <kd>10.0</kd>
            <minDepth>0.001</minDepth>
            <maxVel>0.1</maxVel>
            <material>Gazebo/FlatBlack</material>
        </gazebo>

    <link name="roue_droite">
        <visual>
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <geometry>
                <cylinder radius="${r}" length="${h}"/>
            </geometry>
        </visual>
        <inertial>
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <mass value="${mroue}"/>
            <inertia ixx="${mroue*(3*r*r+h*h)/12}" ixy="0.0" ixz="0.0" iyy="${mroue*(3*r*r+h*h)/12}" iyz="0.0" izz="${mroue*r*r/2}"/>
        </inertial>
        <collision>
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <geometry>
                <cylinder radius="${r}" length="${h}"/>
            </geometry>
        </collision>
    </link>
        <gazebo reference="roue_droite">
            <mu1>1.2</mu1>
            <mu2>1.2</mu2>
            <kp>500000.0</kp>
            <kd>10.0</kd>
            <minDepth>0.001</minDepth>
            <maxVel>0.1</maxVel>
            <material>Gazebo/FlatBlack</material>
        </gazebo>

    <link name="aileron">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <box size="${l_aileron} ${L_aileron} ${h_aileron}"/>
            </geometry>
        </visual>
        <inertial>
            <origin xyz="0 0 ${r/2+h_aileron/2}" rpy="0 0 0"/>
            <mass value="${m_aileron}"/>
            <inertia ixx="${m_aileron*(h_aileron*h_aileron+L_aileron*L_aileron)/12}" ixy="0.0" ixz="0.0" iyy="${m_aileron*(h_aileron*h_aileron+l_aileron*l_aileron)/12}" iyz="0.0" izz="${m_aileron*(L_aileron*L_aileron+l_aileron*l_aileron)/12}"/>
        </inertial>
        <collision>
            <origin xyz="0 0 ${r/2+h_aileron/2}" rpy="0 0 0"/>
            <geometry>
                <box size="${l_aileron} ${L_aileron} ${h_aileron}"/>
            </geometry>
        </collision>
    </link>
    <gazebo reference="aileron">
        <material>Gazebo/WhiteGlow</material>
    </gazebo>

    <link name="cible_verte">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <cylinder radius="${r_cible}" length="${h_cible}"/>
            </geometry>
        </visual>
        <inertial>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <mass value="${m_cible}"/>
            <inertia ixx="${m_cible*(3*r_cible*r_cible+h_cible*h_cible)/12}" ixy="0.0" ixz="0.0" iyy="${m_cible*(3*r_cible*r_cible+h_cible*h_cible)/12}" iyz="0.0" izz="${m_cible*r_cible*r_cible/2}"/>
        </inertial>
        <collision>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <cylinder radius="${r_cible}" length="${h_cible}"/>
            </geometry>
        </collision>
    </link>
    <gazebo reference="cible_verte">
        <material>Gazebo/Green</material>
    </gazebo>

    <link name="cible_rouge">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <cylinder radius="${r_cible}" length="${h_cible}"/>
            </geometry>
        </visual>
        <inertial>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <mass value="${m_cible}"/>
            <inertia ixx="${m_cible*(3*r_cible*r_cible+h_cible*h_cible)/12}" ixy="0.0" ixz="0.0" iyy="${m_cible*(3*r_cible*r_cible+h_cible*h_cible)/12}" iyz="0.0" izz="${m_cible*r_cible*r_cible/2}"/>
        </inertial>
        <collision>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <cylinder radius="${r_cible}" length="${h_cible}"/>
            </geometry>
        </collision>
    </link>
    <gazebo reference="cible_rouge">
        <material>Gazebo/Red</material>
    </gazebo>

    <link name="benne1">
        <visual>
            <geometry>
                <box size="${benne1X} ${benne1Y} ${benne1Z}"/>
            </geometry>
        </visual>
        <collision>
            <geometry>
                <box size="${benne1X} ${benne1Y} ${benne1Z}"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="${benne1_m}"/>
            <inertia ixx="${benne1_m*(benne1Z*benne1Z + benne1Y*benne1Y)/12}" ixy="0.0" ixz="0.0" iyy="${benne1_m*(benne1X*benne1X+benne1Z*benne1Z)/12}" iyz="0.0" izz="${benne1_m*(benne1Y*benne1Y+benne1X*benne1X)/12}"/>
        </inertial>
    </link>

    <link name="benne2">
        <visual>
            <geometry>
                <box size="${benne2X} ${benne2Y} ${benne2Z}"/>
            </geometry>
        </visual>
        <collision>
            <geometry>
                <box size="${benne2X} ${benne2Y} ${benne2Z}"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="${benne2_m}"/>
            <inertia ixx="${benne2_m*(benne2Z*benne2Z + benne2Y*benne2Y)/12}" ixy="0.0" ixz="0.0" iyy="${benne2_m*(benne2X*benne2X+benne2Z*benne2Z)/12}" iyz="0.0" izz="${benne2_m*(benne2Y*benne2Y+benne2X*benne2X)/12}"/>
        </inertial>
    </link>

    <link name="benne3">
        <visual>
            <geometry>
                <box size="${benne2X} ${benne2Y} ${benne2Z}"/>
            </geometry>
        </visual>
        <collision>
            <geometry>
                <box size="${benne2X} ${benne2Y} ${benne2Z}"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="${benne2_m}"/>
            <inertia ixx="${benne2_m*(benne2Z*benne2Z + benne2Y*benne2Y)/12}" ixy="0.0" ixz="0.0" iyy="${benne2_m*(benne2X*benne2X+benne2Z*benne2Z)/12}" iyz="0.0" izz="${benne2_m*(benne2Y*benne2Y+benne2X*benne2X)/12}"/>
        </inertial>
    </link>

    <link name="caster_wheel">
        <visual>
            <geometry>
                    <sphere radius="${free_r}"/>
            </geometry>
        </visual>
        <collision>
        <geometry>            
            <sphere radius="${free_r}"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="${free_m}"/>
            <inertia ixx="${2*free_m*free_r*free_r/5}" ixy="0.0" ixz="0.0" iyy="${2*free_m*free_r*free_r/5}" iyz="0.0" izz="${2*free_m*free_r*free_r/5}"/>
        </inertial>
    </link>
    <gazebo reference="free_wheel">
        <xacro:mat2/>
    </gazebo>
    

    <!-- Joints-->
    <joint name="base_to_roue_gauche" type="continuous">
        <parent link="base"/>
        <child link="roue_gauche"/>
        <origin xyz="0 ${largeur/2+eps+h/2} ${r}"/>
        <axis xyz="0 1 0"/>
    </joint>

    <joint name="base_to_roue_droite" type="continuous">
        <parent link="base"/>
        <child link="roue_droite"/>
        <origin xyz="0 ${-(largeur/2+eps+h/2)} ${r}"/>
        <axis xyz="0 1 0"/>
    </joint>

    <joint name="base_to_aileron" type="fixed">
        <parent link="base"/>
        <child link="aileron"/>
        <origin xyz="${-(longueur/2+l_aileron/2)} 0 ${r-hauteur/2+h_aileron/2}"/>
    </joint>

    <joint name="base_to_cible_verte" type="fixed">
        <parent link="base"/>
        <child link="cible_verte"/>
        <origin xyz="${-longueur/2-l_aileron/2} ${0.1-largeur/2} ${r-hauteur/2+h_aileron+h_cible/2}"/>
    </joint>

    <joint name="base_to_cible_rouge" type="fixed">
        <parent link="base"/>
        <child link="cible_rouge"/>
        <origin xyz="${-longueur/2-l_aileron/2} ${-(0.1-largeur/2)} ${r-hauteur/2+h_aileron+h_cible/2}"/>
    </joint>

    <joint name="benne_1_2" type="fixed">
        <origin xyz="${benne1X/2+benne2X/2} ${benne1Y/2-benne2Y/2} 0" rpi="0 0 0"/>
        <parent link="benne1"/>
        <child link="benne2"/>
    </joint>

    <joint name="benne_1_3" type="fixed">
        <origin xyz="${benne1X/2+benne2X/2} ${-benne1Y/2+benne2Y/2} 0" rpi="0 0 0"/>
        <parent link="benne1"/>
        <child link="benne3"/>
    </joint>

    <joint name="benne_free_wheel" type="fixed">
        <origin xyz="0 0 ${-free_r/2-benne1Z/2}" rpi="0 0 0"/>
        <parent link="benne1"/>
        <child link="caster_wheel"/>
    </joint>

    <joint name="base_to_benne1" type="fixed">
        <parent link="base"/>
        <child link="benne1"/>
        <origin xyz="${(longueur/2+benne1X/2)+0.1} 0 ${r}"/>
    </joint>

    <gazebo>
        <plugin name="joint_states" filename="libgazebo_ros_joint_state_publisher.so">
            <joint_name>base_to_roue_droite</joint_name>
            <joint_name>base_to_roue_gauche</joint_name>
        </plugin>
        
        <plugin name='diff_drive' filename='libgazebo_ros_diff_drive.so'>
            <update_rate>500</update_rate>
            <!-- wheels -->
            <left_joint>base_to_roue_gauche</left_joint>
            <right_joint>base_to_roue_droite</right_joint>

            <!-- kinematics -->
            <wheel_separation>${largeur+2*eps+h}</wheel_separation>
            <wheel_diameter>${2*r}</wheel_diameter>

            <!-- limits -->
            <max_wheel_torque>20</max_wheel_torque>
            <max_acceleration>1.0</max_acceleration>

            <!-- output -->
            <publish_odom>true</publish_odom>
            <publish_odom_tf>true</publish_odom_tf>
            <publish_wheel_tf>true</publish_wheel_tf>
            <odometry_frame>odom</odometry_frame>
            <robot_base_frame>base</robot_base_frame>
        </plugin>
    </gazebo>

</robot>