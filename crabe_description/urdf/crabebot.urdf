<?xml version="1.0"?>

<robot name="crabe" xmlns:xacro="http://www.ros.org/wiki/xacro">

   <xacro:macro name="mat1">
        <mu1>1.2</mu1>
        <mu2>1.2</mu2>
        <kp>500000.0</kp>
        <kd>10.0</kd>
        <minDepth>0.001</minDepth>
        <maxVel>0.1</maxVel>
        <material>Gazebo/FlatBlack</material>
    </xacro:macro>

    <xacro:macro name="mat2">
        <mu1>0.5</mu1>
        <mu2>0.09</mu2>
        <material>Gazebo/FlatBlack</material>
    </xacro:macro>

    <!-- box -->
    <xacro:property name="l_body" value="0.4" />
    <xacro:property name="L_body" value="0.3" />
    <xacro:property name="h_body" value="0.1" />    
    <xacro:property name="m_body" value="10.0" />
    <xacro:property name="hauteur_chassis" value="1.5" />
    <xacro:property name="hauteur_benne" value="0.5" />
    <!-- roues -->
    <xacro:property name="r_wheel" value="0.1" />
    <xacro:property name="h_wheel" value="0.05" />
    <xacro:property name="eps_wheel" value="0.01" />
    <xacro:property name="m_wheel" value="1.0" />

    <!-- cibles -->
    <xacro:property name="r_cible" value="0.05" />
    <xacro:property name="h_cible" value="0.05" />
    <xacro:property name="m_cible" value="0.01" />


    <!-- arm -->
    <xacro:property name="l_arm" value="0.3" />
    <xacro:property name="L_arm" value="0.01" />
    <xacro:property name="h_arm" value="0.1" />
    <xacro:property name="alpha_arm" value="${pi/4}" />
    <xacro:property name="m_arm" value="0.1" />
    
        
    <!-- arm_wheel -->  
    <xacro:property name="r_aw" value="0.01" />
    <xacro:property name="h_aw" value="0.05" />
    <xacro:property name="m_aw" value="0.01" />

    <!-- Free wheel -->
    <xacro:property name="free_r" value="0.05" />
    <xacro:property name="free_m" value="1" />




    <!-- Links-->

    <!-- body -->
    <link name="body">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <box size="${l_body} ${L_body} ${h_body}"/>
            </geometry>
        </visual>
        <inertial>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <mass value="${m_body}"/>
            <inertia ixx="${m_body*(h_body*h_body+L_body*L_body)/12}" ixy="0.0" ixz="0.0" iyy="${m_body*(h_body*h_body+l_body*l_body)/12}" iyz="0.0" izz="${m_body*(L_body*L_body+l_body*l_body)/12}"/>
        </inertial>
        <collision>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <box size="${l_body} ${L_body} ${h_body}"/>
            </geometry>
        </collision>
    </link>
    <gazebo reference="body">
        <material>Gazebo/WhiteGlow</material>
    </gazebo>

    <!-- Roues -->
    <link name="L_wheel">
        <visual>
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <geometry>
                <cylinder radius="${r_wheel}" length="${h_wheel}"/>
            </geometry>
        </visual>
        <inertial>
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <mass value="${m_wheel}"/>
            <inertia ixx="${m_wheel*(3*r_wheel*r_wheel+h_wheel*h_wheel)/12}" ixy="0.0" ixz="0.0" iyy="${m_wheel*(3*r_wheel*r_wheel+h_wheel*h_wheel)/12}" iyz="0.0" izz="${m_wheel*r_wheel*r_wheel/2}"/>
        </inertial>
        <collision>
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <geometry>
                <cylinder radius="${r_wheel}" length="${h_wheel}"/>
            </geometry>
        </collision>
    </link>
    <gazebo reference="L_wheel">
        <xacro:mat1/>
    </gazebo>

    <link name="R_wheel">
        <visual>
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <geometry>
                <cylinder radius="${r_wheel}" length="${h_wheel}"/>
            </geometry>
        </visual>
        <inertial>
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <mass value="${m_wheel}"/>
            <inertia ixx="${m_wheel*(3*r_wheel*r_wheel+h_wheel*h_wheel)/12}" ixy="0.0" ixz="0.0" iyy="${m_wheel*(3*r_wheel*r_wheel+h_wheel*h_wheel)/12}" iyz="0.0" izz="${m_wheel*r_wheel*r_wheel/2}"/>
        </inertial>
        <collision>
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <geometry>
                <cylinder radius="${r_wheel}" length="${h_wheel}"/>
            </geometry>
        </collision>
    </link>
    <gazebo reference="R_wheel">
        <xacro:mat1/>
    </gazebo>



    <!-- Cibles -->

    <link name="cible_verte">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <cylinder radius="${r_cible}" length="${h_cible}"/>
            </geometry>
        </visual>
        <inertial>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <mass value="${m_cible}"/>
            <inertia ixx="${m_cible*(3*r_cible*r_cible+h_cible*h_cible)/12}" ixy="0.0" ixz="0.0" iyy="${m_cible*(3*r_cible*r_cible+h_cible*h_cible)/12}" iyz="0.0" izz="${m_cible*r_cible*r_cible/2}"/>
        </inertial>
        <collision>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <cylinder radius="${r_cible}" length="${h_cible}"/>
            </geometry>
        </collision>
    </link>
    <gazebo reference="cible_verte">
        <material>Gazebo/Green</material>
    </gazebo>

    <link name="cible_rouge">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <cylinder radius="${r_cible}" length="${h_cible}"/>
            </geometry>
        </visual>
        <inertial>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <mass value="${m_cible}"/>
            <inertia ixx="${m_cible*(3*r_cible*r_cible+h_cible*h_cible)/12}" ixy="0.0" ixz="0.0" iyy="${m_cible*(3*r_cible*r_cible+h_cible*h_cible)/12}" iyz="0.0" izz="${m_cible*r_cible*r_cible/2}"/>
        </inertial>
        <collision>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <cylinder radius="${r_cible}" length="${h_cible}"/>
            </geometry>
        </collision>
    </link>
    <gazebo reference="cible_rouge">
        <material>Gazebo/Red</material>
    </gazebo>

    <!-- arm -->
    <link name="Left_arm">

        <visual>
            <geometry>
                <box size="${l_arm} ${L_arm} ${h_arm}"/>
            </geometry>
        </visual>
        <collision>
            <geometry>
                <box size="${l_arm} ${L_arm} ${h_arm}"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="${m_arm}"/>
            <inertia ixx="${m_arm*(h_arm*h_arm + L_arm*L_arm)/12}" ixy="0.0" ixz="0.0" iyy="${m_arm*(m_arm*m_arm+h_arm*h_arm)/12}" iyz="0.0" izz="${m_arm*(L_arm*L_arm+l_arm*l_arm)/12}"/>
        </inertial>
    </link>

    <link name="Right_arm">
        <visual>
            <geometry>
                <box size="${l_arm} ${L_arm} ${h_arm}"/>
            </geometry>
        </visual>
        <collision>
            <geometry>
                <box size="${l_arm} ${L_arm} ${h_arm}"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="${m_arm}"/>
            <inertia ixx="${m_arm*(h_arm*h_arm + L_arm*L_arm)/12}" ixy="0.0" ixz="0.0" iyy="${m_arm*(m_arm*m_arm+h_arm*h_arm)/12}" iyz="0.0" izz="${m_arm*(L_arm*L_arm+l_arm*l_arm)/12}"/>
        </inertial>
    </link>


    <!-- Caster Wheel -->

    <link name="caster_wheel">
        <visual>
            <geometry>
                    <sphere radius="${free_r}"/>
            </geometry>
        </visual>
        <collision>
        <geometry>            
            <sphere radius="${free_r}"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="${free_m}"/>
            <inertia ixx="${2*free_m*free_r*free_r/5}" ixy="0.0" ixz="0.0" iyy="${2*free_m*free_r*free_r/5}" iyz="0.0" izz="${2*free_m*free_r*free_r/5}"/>
        </inertial>
    </link>
    <gazebo reference="caster_wheel">
        <xacro:mat2/>
    </gazebo>
    

    <!-- Joints-->
    <joint name="Body_L_wheel" type="continuous">
        <parent link="body"/>
        <child link="L_wheel"/>
        <origin xyz="0.1 ${L_body/2+eps_wheel} ${-h_body/2}"/>
        <axis xyz="0 1 0"/>
    </joint>

    <joint name="Body_R_wheel" type="continuous">
        <parent link="body"/>
        <child link="R_wheel"/>
        <origin xyz="0.1 -${L_body/2+eps_wheel} ${-h_body/2}"/>
        <axis xyz="0 1 0"/>
    </joint>


    <joint name="body_cible_verte" type="fixed">
        <parent link="body"/>
        <child link="cible_verte"/>
        <origin xyz="-0.15 0.1 ${h_body/2}"/>
    </joint>

    <joint name="body_cible_rouge" type="fixed">
        <parent link="body"/>
        <child link="cible_rouge"/>
        <origin xyz="-0.15 -0.1 ${h_body/2}"/>
    </joint>

    <joint name="body_L_arm" type="fixed">
        <origin xyz="${l_body/2} ${L_body/2*cos(alpha_arm)} -0.09" rpy="0 0 ${alpha_arm}"/>
        <parent link="body"/>
        <child link="Left_arm"/>
    </joint>

    <joint name="body_R_arm" type="fixed">
        <origin xyz="${l_body/2} -${L_body/2*cos(alpha_arm)} -0.09" rpy="0 0 -${alpha_arm}"/>
        <parent link="body"/>
        <child link="Right_arm"/>
    </joint>


    <joint name="base_casterWheel" type="fixed">
        <origin xyz="-0.15 0 -${free_r + h_body/2}"/>
        <parent link="body"/>
        <child link="caster_wheel"/>
    </joint>

    <gazebo>
        <plugin name="joint_states" filename="libgazebo_ros_joint_state_publisher.so">
            <joint_name>Body_R_wheel</joint_name>
            <joint_name>Body_L_wheel</joint_name>
        </plugin>
        
        <plugin name='diff_drive' filename='libgazebo_ros_diff_drive.so'>
            <update_rate>500</update_rate>
            <!-- wheels -->
            <left_joint>Body_L_wheel</left_joint>
            <right_joint>Body_R_wheel</right_joint>

            <!-- kinematics -->
            <wheel_separation>${L_body+2*eps_wheel+h_wheel}</wheel_separation>
            <wheel_diameter>${2*r_wheel}</wheel_diameter>

            <!-- limits -->
            <max_wheel_torque>20</max_wheel_torque>
            <max_acceleration>1.0</max_acceleration>

            <!-- output -->
            <publish_odom>true</publish_odom>
            <publish_odom_tf>true</publish_odom_tf>
            <publish_wheel_tf>true</publish_wheel_tf>
            <odometry_frame>odom</odometry_frame>
            <robot_base_frame>body</robot_base_frame>
        </plugin>
    </gazebo>

</robot>